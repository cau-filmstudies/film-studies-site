<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" content="notranslate" />
    <title>CMS - 중앙대학교 영화학과</title>
    <style>
      /* 완전히 격리된 CMS 스타일 */
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #fff;
        overflow-x: hidden;
      }

      #nc-root {
        min-height: 100vh;
        position: relative;
        z-index: 1;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        font-size: 18px;
        color: #666;
      }

      /* Decap CMS 스타일 격리 */
      #nc-root * {
        font-family: inherit;
      }
    </style>
  </head>
  <body>
    <div id="nc-root">
      <div class="loading">CMS 로딩 중...</div>
    </div>

    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v3/netlify-identity-widget.js"></script>

    <!-- Decap CMS - 최신 안정 버전 -->
    <script src="https://unpkg.com/decap-cms@3.8.0/dist/decap-cms.js"></script>

    <!-- CMS 설정 -->
    <script>
      // 중복 초기화 방지
      let cmsInitialized = false

      // 안전한 CMS 초기화
      function initCMS() {
        if (cmsInitialized) {
          console.log('CMS가 이미 초기화되었습니다.')
          return
        }

        if (window.CMS) {
          try {
            console.log('CMS 초기화 시작...')

            const config = {
              backend: {
                name: 'git-gateway',
                branch: 'main',
              },
              media_folder: 'public/images/uploads',
              public_folder: '/images/uploads',
              collections: [
                {
                  name: 'board',
                  label: '게시판',
                  folder: 'content/board',
                  create: true,
                  slug: '{{year}}{{month}}{{day}}-{{slug}}',
                  fields: [
                    {
                      label: '제목',
                      name: 'title',
                      widget: 'string',
                      required: true,
                    },
                    {
                      label: '작성일',
                      name: 'date',
                      widget: 'datetime',
                      format: 'YYYY-MM-DD',
                      date_format: 'YYYY-MM-DD',
                      time_format: false,
                      default: 'now',
                    },
                    {
                      label: '작성자',
                      name: 'author',
                      widget: 'string',
                      required: true,
                    },
                    {
                      label: '내용',
                      name: 'body',
                      widget: 'markdown',
                      required: true,
                    },
                  ],
                },
              ],
            }

            window.CMS.init({ config })
            cmsInitialized = true
            console.log('CMS 초기화 완료')
          } catch (error) {
            console.error('CMS 초기화 오류:', error)
            document.querySelector('.loading').textContent =
              'CMS 로딩 실패. 페이지를 새로고침해주세요.'
          }
        } else {
          setTimeout(initCMS, 100)
        }
      }

      // DOM 로드 후 초기화
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCMS)
      } else {
        initCMS()
      }
    </script>
  </body>
</html>
