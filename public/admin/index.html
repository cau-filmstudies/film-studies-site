<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google" content="notranslate" />
    <title>CMS - 중앙대학교 영화학과</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #fff;
        overflow-x: hidden;
      }

      #nc-root {
        min-height: 100vh;
        position: relative;
        z-index: 1;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        font-size: 18px;
        color: #666;
      }

      /* Decap CMS 스타일 격리 */
      #nc-root * {
        font-family: inherit;
      }

      /* DOM 조작 오류 방지를 위한 추가 스타일 */
      .cms-container {
        position: relative;
        min-height: 100vh;
      }
    </style>
  </head>
  <body>
    <div class="cms-container">
      <div id="nc-root">
        <div class="loading">CMS 로딩 중...</div>
      </div>
    </div>

    <!-- Decap CMS - 안정적인 버전 -->
    <script src="https://unpkg.com/decap-cms@3.3.0/dist/decap-cms.js"></script>

    <!-- CMS 설정 -->
    <script>
      // DOM 조작 오류 방지 함수
      function safeRemoveChild(parent, child) {
        if (parent && child && parent.contains(child)) {
          try {
            parent.removeChild(child)
          } catch (error) {
            console.warn('DOM 조작 오류 방지:', error)
          }
        }
      }

      // Decap CMS 설정
      const config = {
        backend: {
          name: 'github',
          repo: 'cau-filmstudies/film-studies-site',
          branch: 'main',
          auth_scope: 'repo',
          client_id: 'Ov23libaKgVihLREnBGa',
        },
        media_folder: 'public/images/uploads',
        public_folder: '/images/uploads',
        collections: [
          {
            name: 'board',
            label: '게시판',
            folder: 'content/board',
            create: true,
            slug: '{{year}}{{month}}{{day}}-{{slug}}',
            fields: [
              {
                label: '제목',
                name: 'title',
                widget: 'string',
                required: true,
              },
              {
                label: '작성일',
                name: 'date',
                widget: 'datetime',
                format: 'YYYY-MM-DD',
                date_format: 'YYYY-MM-DD',
                time_format: false,
                default: 'now',
              },
              {
                label: '작성자',
                name: 'author',
                widget: 'string',
                required: true,
              },
              {
                label: '내용',
                name: 'body',
                widget: 'markdown',
                required: true,
              },
            ],
          },
          {
            name: 'pages',
            label: '페이지',
            folder: 'content/pages',
            create: true,
            slug: '{{slug}}',
            fields: [
              {
                label: '제목',
                name: 'title',
                widget: 'string',
                required: true,
              },
              {
                label: '내용',
                name: 'body',
                widget: 'markdown',
                required: true,
              },
            ],
          },
        ],
      }

      // CMS 초기화 - 더 안전한 방법
      function initCMS() {
        if (window.CMS) {
          try {
            // DOM 조작 오류 방지를 위한 전역 함수 설정
            window.safeRemoveChild = safeRemoveChild

            // CMS 초기화 전에 DOM 정리
            const root = document.getElementById('nc-root')
            if (root) {
              const loading = root.querySelector('.loading')
              if (loading) {
                safeRemoveChild(root, loading)
              }
            }

            window.CMS.init({ config })
            console.log('CMS 초기화 성공')
          } catch (error) {
            console.error('CMS 초기화 오류:', error)
            document.getElementById('nc-root').innerHTML =
              '<div style="padding: 20px; text-align: center;">CMS 초기화 중 오류가 발생했습니다. 페이지를 새로고침해주세요.</div>'
          }
        } else {
          console.log('CMS 로딩 대기 중...')
          setTimeout(initCMS, 1000)
        }
      }

      // 페이지 로드 후 CMS 초기화
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
          setTimeout(initCMS, 100)
        })
      } else {
        setTimeout(initCMS, 100)
      }

      // 전역 오류 처리
      window.addEventListener('error', function (event) {
        if (
          event.error &&
          event.error.message &&
          event.error.message.includes('removeChild')
        ) {
          console.warn('DOM 조작 오류 감지, 무시합니다:', event.error)
          event.preventDefault()
        }
      })
    </script>
  </body>
</html>
